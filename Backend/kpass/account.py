from kpass.orm import ORM
import bcrypt
from .util import hash_password
import random
from .passwords import Passwords
from cryptography.fernet import Fernet


class Account(ORM):
#--------------------------------------------------------------------------------------------------------------------
#-------------Class variables----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    tablename = "accounts"
    fields = ['username', 'password_hash', 'salt', 'email', 'api_key', 'user_key']



#--------------------------------------------------------------------------------------------------------------------
#-------------Class constructor----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def __init__(self, **kwargs):
        self.pk = kwargs.get('pk')
        self.username = kwargs.get('username')
        self.password_hash = kwargs.get('password_hash')
        self.email = kwargs.get("email")
        self.api_key = kwargs.get("api_key")
        self.salt = kwargs.get("salt")
        self.user_key = kwargs.get("user_key")
        
#--------------------------------------------------------------------------------------------------------------------
#-------------main login----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    @classmethod
    def login(cls, username,  password):
        #W
        salt = cls.one_col_from_where_clause("salt", "WHERE username=?", (username,))
        if salt:

            return cls.one_from_where_clause("WHERE username=? AND password_hash=?",
                                        (username, hash_password(password,salt) ))
        else:
            return None


#--------------------------------------------------------------------------------------------------------------------
#-------------Passwords setting----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def set_password(self, password):
        self.salt = bcrypt.gensalt()
        self.password_hash = hash_password(password, self.salt)


#--------------------------------------------------------------------------------------------------------------------
#-------------User API----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def generate_api_key(self):
        """
        This method sets the  self.api_key 
        property to a random string of at least 20 
        numbers or characters

        """
        start = 10**19
        end = (10**20)-1
       
        new_api = random.randint(start,end)
        self.api_key = str(new_api)
        return self.api_key

    def get_api(self):
        return self.api_key


#--------------------------------------------------------------------------------------------------------------------
#-------------User Auth----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    # classmethod of Account called api_authenticate
    @classmethod
    def api_authenticate(cls, api_key):
        return cls.one_from_where_clause("WHERE api_key=?",
                                        (api_key,))


#--------------------------------------------------------------------------------------------------------------------
#-------------retrieve Password from Database----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def get_passwords(self):
        """return all Password where account_pk == self.pk
        returns a lis of Passwords objects"""
        return Passwords.all_from_where_clause("WHERE account_pk=?", (self.pk,))



#--------------------------------------------------------------------------------------------------------------------
#-------------search query----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def search(self, site):
        return Passwords.all_from_where_clause("WHERE site_name=?", values=(site,))



#--------------------------------------------------------------------------------------------------------------------
#-------------Key Auth----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def set_key(self):
        self.user_key = Fernet.generate_key()

#--------------------------------------------------------------------------------------------------------------------
#-------------Get User Key for pass decryption----------------------------------------------------------------------------------------
#--------------------------------------------------------------------------------------------------------------------
    def get_key(self):
        return self.user_key